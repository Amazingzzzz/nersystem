<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <head th:replace="common/common_css :: css(~{::link})">
    </head>
    <title>主页</title>
    <style>
        /* CSS */
        .borderstyle {
            border: 1px solid #b6b6b6;
            width: 320px;
            height: 240px;
        }

        #camera {
            float: left;
            margin: 10px;
        }

        #canvas {
            width: 320px;
            height: 240px;
            margin: 10px;
        }
    </style>
</head>
<body>
<div id="wrapper">
    <div th:replace="common/common_left :: left"></div>

    <div id="content-wrapper" class="d-flex flex-column">
        <div id="content">
            <div th:replace="common/common_head :: head"></div>

            <!--正文-->
            <div>
                <div class="card shadow mb-4" style="margin-left: 2.5%">
                    <div class="card-body">
                        <div style=" margin-left: 1%;margin-right: 1%">
                            <h1>hello</h1>


                            <div id="webcam"></div>
                            <canvas id="canvas" width="320" height="240"></canvas>
                            <input id="snapBtn" type="button" value="拍照" onclick="getUserID()"/>
                            <input id="snapBtn2" type="button" value="重拍"/>
                            <input id="base64image" type="hidden"/>

                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
<div>
    <div th:replace="common/common_js :: js(~{::script})"></div>
    <script type="text/javascript" th:src="@{/js/jquery.webcam.js}"></script>
    <script type="text/javascript">
        $(function () {
            $("#snapBtn2").hide()
        });
        var pos = 0,
            ctx = null,
            image = [];
        var w = 320;
        var h = 240;
        $(document).ready(function () {

            jQuery("#webcam").webcam({

                width: 320,
                height: 240,
                mode: "callback",
                swffile: "js/jscam_canvas_only.swf", // 这里引入swf文件，注意路径
                onTick: function (remain) {
                },
                onSave: function (data) {

                    var col = data.split(";");
                    var img = image;

                    for (var i = 0; i < 320; i++) {
                        var tmp = parseInt(col[i]);
                        img.data[pos + 0] = (tmp >> 16) & 0xff;
                        img.data[pos + 1] = (tmp >> 8) & 0xff;
                        img.data[pos + 2] = tmp & 0xff;
                        img.data[pos + 3] = 0xff;
                        pos += 4;
                    }

                    if (pos >= 4 * 320 * 240) {

                        // 将图片显示到canvas中
                        ctx.putImageData(img, 0, 0);

                        // 取得图片的base64码
                        var base64 = canvas.toDataURL("image/png");
                        $("#base64image").val(base64);

                        pos = 0;

                    }

                },

                onCapture: function () {
                    webcam.save();
                    // Show a flash for example
                },

                debug: function (type, string) {
                    console.log('type:' + type + ',string:' + string);
                    // Write debug information to console.log() or a div
                },

                onLoad: function () {
                    // Page load
                }

            });
            window.addEventListener("load", function () {

                var canvas = document.getElementById("canvas");

                if (canvas.getContext) {
                    ctx = canvas.getContext("2d");
                    ctx.clearRect(0, 0, 320, 240);

                    var img = new Image();
                    img.onload = function () {
                        ctx.drawImage(img, 129, 89);
                    }
                    image = ctx.getImageData(0, 0, 320, 240);
                }

            }, false);

            /*            $('#snapBtn').on('click', function () {

                            webcam.capture();
                            $('#snapBtn').hide();
                            $("#webcam").hide();

                            $("#snapBtn2").show();

                        });
                        $("#snapBtn2").on('click', function () {


                            $("#webcam").show();
                            $('#snapBtn').show();

                            $("#snapBtn2").hide();

                        })*/
        });

        function getUserID() {
            webcam.capture();
            $.ajax({
                url: "/register/getUserID",
                type: "post",
                data: {
                    "image": $("#base64image").val()
                }
            })
        }
    </script>
</div>
</body>
</html>